<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>7점 → 폐곡선 → 실행 (안정版)</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden;font:14px system-ui,Segoe UI,Arial}
  canvas{display:block;touch-action:none}
  .hud{
    position:fixed;left:10px;top:10px;z-index:10;
    background:rgba(0,0,0,.65);color:#fff;border-radius:12px;padding:10px 12px;min-width:220px
  }
  .hud h3{margin:.1rem 0 .4rem;font-size:15px}
  .btn{width:100%;margin-top:.4rem;border:0;border-radius:8px;padding:.5rem .6rem;cursor:pointer}
  #start{background:#1f6cff;color:#fff;opacity:.5;pointer-events:none}
  #reset{background:#444;color:#fff}
  #status{font-size:12px;opacity:.9;margin-top:.3rem}
</style>
</head>
<body>
<canvas id="cv"></canvas>

<div class="hud">
  <h3>① 화면을 탭/클릭해 <b>7점</b>을 찍으세요</h3>
  <div>• 실수하면 <b>두 손가락 탭</b>(또는 우클릭)으로 <b>되돌리기</b></div>
  <button id="reset" class="btn">모두 지우기</button>
  <button id="start" class="btn">② 실행</button>
  <div id="status">0 / 7</div>
</div>

<script>
const cvs = document.getElementById('cv');
const ctx = cvs.getContext('2d', {alpha:false});
let W=innerWidth, H=innerHeight; cvs.width=W; cvs.height=H;
addEventListener('resize', ()=>{W=innerWidth;H=innerHeight;cvs.width=W;cvs.height=H;draw();});

const pts=[];             // {x,y} 7개
let running=false;
const statusEl = document.getElementById('status');
const startBtn = document.getElementById('start');

// --- 입력: 포인터/터치 모두 매끄럽게 ---
function getPos(e){
  const r=cvs.getBoundingClientRect();
  const c = (e.touches? e.touches[0] : e);
  return {x: c.clientX - r.left, y: c.clientY - r.top};
}
function addPoint(p){
  if(running||pts.length>=7) return;
  pts.push(p);
  if(pts.length===7){ startBtn.style.opacity=1; startBtn.style.pointerEvents='auto'; }
  statusEl.textContent = `${pts.length} / 7`;
  draw();
}
function undo(){
  if(running||pts.length===0) return;
  pts.pop();
  if(pts.length<7){ startBtn.style.opacity=.5; startBtn.style.pointerEvents='none'; }
  statusEl.textContent = `${pts.length} / 7`;
  draw();
}

cvs.addEventListener('pointerdown', e=>{ addPoint(getPos(e)); });
cvs.addEventListener('contextmenu', e=>{ e.preventDefault(); undo(); });
cvs.addEventListener('touchstart', e=>{
  if(e.touches.length===2){ e.preventDefault(); undo(); return; }
  if(e.touches.length===1){ addPoint(getPos(e)); }
},{passive:false});

document.getElementById('reset').onclick=()=>{ if(running) return; pts.length=0; startBtn.style.opacity=.5; startBtn.style.pointerEvents='none'; statusEl.textContent='0 / 7'; draw(); };

// --- 그리기: 점 + 선(폐곡선) ---
function draw(){
  ctx.fillStyle="#000"; ctx.fillRect(0,0,W,H);

  // 연결선
  if(pts.length>0){
    ctx.strokeStyle="#ffea00"; ctx.lineWidth=2.2; ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
    if(pts.length===7) ctx.lineTo(pts[0].x, pts[0].y); // 마지막→처음
    ctx.stroke();
  }
  // 점
  for(const p of pts){
    ctx.fillStyle="#ffee66"; ctx.beginPath(); ctx.arc(p.x,p.y,6,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle="#222"; ctx.lineWidth=1; ctx.stroke();
  }
}

// --- 실행: 간단한 원형 파동 애니메이션(확실히 보이는 버전) ---
startBtn.onclick=()=>{
  if(pts.length!==7 || running) return;
  running=true;
  const cx = pts.reduce((s,p)=>s+p.x,0)/7, cy = pts.reduce((s,p)=>s+p.y,0)/7;
  let t0=performance.now();
  requestAnimationFrame(function loop(t){
    if(!running) return;
    const time=(t-t0)*0.001;
    ctx.fillStyle="#000"; ctx.fillRect(0,0,W,H);

    // 배경 링
    const maxR=Math.hypot(Math.max(cx,W-cx), Math.max(cy,H-cy))+20;
    for(let i=0;i<1200;i++){
      const baseR=i*3.2 + time*6; if(baseR>maxR) break;
      const lobes=4, war=22*Math.sin(lobes*0.02*i + time*2.0);
      const r=baseR+war;
      ctx.strokeStyle=`hsl(${(i*7)%360} 90% 55%)`;
      ctx.lineWidth=0.7; ctx.beginPath();
      for(let a=0;a<=Math.PI*2+0.02;a+=0.02){
        const x=cx+Math.cos(a)*r, y=cy+Math.sin(a)*r;
        if(a===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }

    // 7각형 윤곽(살짝 빛나게)
    ctx.strokeStyle="rgba(255,234,0,.9)"; ctx.lineWidth=2.4; ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    for(let i=1;i<7;i++) ctx.lineTo(pts[i].x, pts[i].y);
    ctx.lineTo(pts[0].x, pts[0].y); ctx.stroke();

    requestAnimationFrame(loop);
  });
};

draw();
</script>
</body>
</html>
